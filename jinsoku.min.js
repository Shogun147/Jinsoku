(function(){"use strict";var Jinsoku={version:"0.1.0",settings:{strip:!0,dataname:"data",extract:!1,import_deps:!0,wrap:!1,scope:{}},keys:"",template:null,parsers:{},compile:function(e,t,n){var r=this;typeof t=="function"&&(n=t,t={});var i,s={content:"",templates:{},deps:[],mixins:{},pending:1};return r.extend(e,s,function(){var t=Object.keys(s.templates);s.templates[e].content="var body = '"+s.templates[e].content+"'; return body;",r.settings.extract&&(s.templates[e].content="var __data = ''; for (var __k in data) { __data += ' var '+__k+' = data[\"'+__k+'\"];'; } eval(__data); __data = __k = undefined; "+s.templates[e].content);for(var o=t.length;o>0;o--){var u=s.templates[t[o-1]];for(var a in u.partials)s.templates[a].content+=u.partials[a]}for(var u in s.templates){r.parse(u,s);for(var f in s.templates[u].blocks){var l=s.templates[u].blocks[f];l.content=l.prepend.join("")+l.content+l.append.join(""),s.templates[u].content=s.templates[u].content.replace("{#block:"+f+"#}",l.content)}}for(var u in s.templates)for(var a in s.templates[u].partials)s.templates[e].content=s.templates[e].content.replace("{#template:"+a+"#}",s.templates[a].content);r.settings.strip&&(s.templates[e].content=s.templates[e].content.replace(/(^|\r|\n)\t*\s+|\s+\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,"")),s.templates[e].content=s.templates[e].content.replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/\n/g,"");if(r.settings.import_deps){var c={};s.deps.forEach(function(t){c[t]||(s.templates[e].content=r[t].toString()+s.templates[e].content,c[i]=!0)})}i=new Function(r.settings.dataname,s.templates[e].content),r.settings.wrap&&(i=new Function("data",i.toString()+" return anonymous.call(Jinsoku.settings.scope, data);")),n&&n(i)}),i},parse:function(e,t){var n=this,r=t.templates[e];r.content=r.content.replace(/\[(block|prepend|append):\s*([^\]]+)([!]?)\]([\s\S]*?)\[\/\1\]/g,function(e,t,n,i,s){var o=!1;return r.blocks[n]||(r.blocks[n]={content:"",prepend:[],append:[]},o=!0),t=="block"?(r.blocks[n].content=s,o||i?"{#block:"+n+"#}":""):(r.blocks[n][t].push(s),"")}),n._parse(e,t)},_parse:function(e,t){var n=this,e=t.templates[e];for(var r in n.parsers)r=n.parsers[r],e.content=e.content.replace(r.regexp,function(){var i=Array.prototype.slice.call(arguments,1);return i.unshift(e,t),r.callback.apply(n,i)});e.content=e.content.replace(new RegExp("\\[\\/("+Object.keys(n.parsers).join("|")+"|/)\\]","g"),"'; } body += '")},extend:function(e,t,n){var r=this;r.template(e,function(i){i=i.replace(/`|'|\\/g,"\\$&"),t.templates[e]={content:i,partials:{},blocks:{},includes:0},r.include(e,t,function(){t.templates[e].content=t.templates[e].content.replace(/\[extend:\s*([^\]]+)\]([\s\S]*?)\[\/extend\]/g,function(i,s,o){return t.pending++,t.templates[e].partials[s]=o,r.extend(s,t,n),"{#template:"+s+"#}"}),--t.pending||n()})})},include:function(e,t,n){var r=this,i=/\[include:\s*([^\]]+)\s*\]/g,s=t.templates[e].content,o=[],u;while((u=i.exec(s))!=null)o.push(u[1]);t.templates[e].includes+=o.length,t.templates[e].includes||n&&n(),o.forEach(function(i){r.template(i,function(s){s=s.replace(/`|'|\\/g,"\\$&"),t.templates[e].content=t.templates[e].content.replace(new RegExp("\\[include:\\s*"+i+"\\s*\\]"),s),r.include(e,t,n),--t.templates[e].includes||n&&n()})})},parser:function(e,t,n){this.parsers[e]={regexp:t,callback:n}}};Jinsoku.parser("clone",/\[clone:\s*([^\]]+)\s*\]/g,function(e,t,n){return e.blocks[n]&&e.blocks[n].content||"#block: "+n+"#"}),Jinsoku.parser("if",/\[if:([^\]]+)\]([\s\S]*?)\[\/if\]/g,function(e,t,n,r){var i="'; if ("+n+") { body +='"+r+"'; } body +='";return i=i.replace(/\[(?::([^\]]+)?)\]/g,function(e,t){return"'; } else "+(t?"if ("+t+")":"")+"{ body +='"}),i}),Jinsoku.parser("each",/\[each:([^:\]\s]+)\s*(?::([^:\]]+))?\s*(?::([^:\]]+))?\]/g,function(e,t,n,r,i){i=i||"i";var s="'; for (var "+i+"=0, _len="+n+".length; "+i+"<_len; "+i+"++) { var "+r+" = "+n+"["+i+"]; body += '";return s}),Jinsoku.parser("for",/\[for:([^:\]\s]+)\s*(?::([^:\]]+))?\s*(?::([^:\]]+))?\]/g,function(e,t,n,r,i){i=i||"i";var s="'; for (var "+i+" in "+n+") { var "+r+" = "+n+"["+i+"]; body += '";return s}),Jinsoku.parser("case",/\[case:\s*([^\]]+)\]([\s\S]*?)\[\/case\]/g,function(e,t,n,r){var i="'; switch("+n+") {"+r.replace(/^\n*/," ").replace(/\n*$/," ")+" ";return i=i.replace(/\[:(?:([^\]]+))?\](?:([^:\[]+))/g,function(e,t,n){return(t?" case "+t:" default")+": body += '"+n+"'; break;"}),i+="} body += '",i}),Jinsoku.parser("var",/(#|!)\[([\s\S]+?)\s*(?::([^\]]+))?\]/g,function(e,t,n,r,i){var s,o=n==="!";return o&&t.deps.push("encodeHtml"),r=r.replace(/^([a-z_$][a-z0-9_$\.\[\]\'\"]*)(.*)$/i,function(e,t,n){return s=n,t}),i!==undefined?"'; var "+r+" = "+i+s+"; body += '":"'+ "+(o?"encodeHtml":"")+"("+(s?r+s:r)+") +'"}),Jinsoku.parser("evaluate",/\[#([\s\S]+?)#\]/g,function(e,t,n){return"'; "+this.unescape(n)+" body += '"}),Jinsoku.encodeHtml=function(t){var n={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;","`":"&#96;"},r=/&(?!#?\w+;)|<|>|"|'|\//g;return t?t.toString().replace(r,function(e){return n[e]||e}):t},Jinsoku.unescape=function(t){return t.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ")};var g=function(){return this||(0,eval)("this")}();typeof module!="undefined"&&module.exports?module.exports=Jinsoku:typeof define=="function"&&define.amd?define(function(){return Jinsoku}):g.Jinsoku=Jinsoku,typeof global!="undefined"&&(global.Jinsoku=Jinsoku)})();